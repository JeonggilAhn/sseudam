#!/bin/sh

# ì»¤ë°‹ ë©”ì‹œì§€ íŒŒì¼ ê²½ë¡œ
commit_msg_file=$1

# ì»¤ë°‹ ë©”ì‹œì§€ ì½ê¸°
commit_msg=$(cat "$commit_msg_file")

# í—ˆìš©ë˜ëŠ” prefix ëª©ë¡
allowed_prefixes="feat fix docs style refactor test chore hotfix wip"

# prefix ê²€ì‚¬
is_valid=false
prefix_found=""
for prefix in $allowed_prefixes; do
  if [[ "$commit_msg" == "$prefix : "* ]]; then
    is_valid=true
    prefix_found=$prefix
    break
  fi
done

# ìœ íš¨í•˜ì§€ ì•Šì€ prefixì¸ ê²½ìš° ì»¤ë°‹ ê±°ë¶€
if ! $is_valid; then
  echo "Error: ì»¤ë°‹ ë©”ì‹œì§€ prefixê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
  echo "í—ˆìš©ë˜ëŠ” prefix: $allowed_prefixes"
  echo "prefix í›„ì— ë„ì–´ì“°ê¸°ë¥¼ í•´ì£¼ì„¸ìš”."
  exit 1
fi

# í˜„ìž¬ ë¸Œëžœì¹˜ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
branch_name=$(git symbolic-ref --short HEAD)

# ë¸Œëžœì¹˜ ì´ë¦„ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ ì¶”ì¶œ
issue_number=$(echo "$branch_name" | grep -oE 'S12P21A106-[0-9]+')

# ì»¤ë°‹ ë©”ì‹œì§€ì— ì´ë¯¸ ì´ìŠˆ ë²ˆí˜¸ê°€ ìžˆëŠ”ì§€ í™•ì¸
if [[ "$commit_msg" =~ \#S12P21A106-[0-9]+ ]]; then
  has_issue=true
else
  has_issue=false
fi

# ì´ëª¨ì§€ê°€ ì´ë¯¸ ìžˆëŠ”ì§€ í™•ì¸
if [[ "$commit_msg" =~ ^[[:space:]]*[[:punct:]].*$ ]]; then
  has_emoji=true
else
  has_emoji=false
fi

# ì´ëª¨ì§€ ë§¤í•‘
case $prefix_found in
  "feat") emoji="âœ¨";;
  "fix") emoji="ðŸ›";;
  "docs") emoji="ðŸ“";;
  "style") emoji="ðŸŽ¨";;
  "refactor") emoji="â™»ï¸";;
  "test") emoji="â˜‘ï¸";;
  "chore") emoji="âš™ï¸";;
  "hotfix") emoji="ðŸ‘º";;
  "wip") emoji="ðŸš§";;
esac

# ìµœì¢… ë©”ì‹œì§€
new_commit_msg="$commit_msg"

# ì´ëª¨ì§€ê°€ ì—†ìœ¼ë©´ ì•žì— ì¶”ê°€
if ! $has_emoji; then
  new_commit_msg="$emoji $new_commit_msg"
fi

if [[ "$prefix_found" != "hotfix" ]]; then

  # ì»¤ë°‹ ë©”ì‹œì§€ì— ì´ìŠˆ ë²ˆí˜¸ê°€ ì´ë¯¸ ìžˆëŠ”ì§€ í™•ì¸
  if [[ "$commit_msg" =~ \#S12P21A106-[0-9]+ ]]; then
    has_issue=true
  else
    has_issue=false
  fi

  # í˜„ìž¬ ë¸Œëžœì¹˜ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
  branch_name=$(git symbolic-ref --short HEAD)

  # ë¸Œëžœì¹˜ ì´ë¦„ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ ì¶”ì¶œ
  issue_number=$(echo "$branch_name" | grep -oE 'S12P21A106-[0-9]+')

  # ë©”ì‹œì§€ì— ì´ìŠˆ ë²ˆí˜¸ê°€ ì—†ë‹¤ë©´ ì¶”ê°€
  if ! $has_issue; then
    new_commit_msg="$new_commit_msg #$issue_number"
  fi
fi

# ì»¤ë°‹ ë©”ì‹œì§€ ë®ì–´ì“°ê¸°
echo "$new_commit_msg" > "$commit_msg_file"
